---
title: Java8-æµ
date: 2021-03-09T07:21:52+00:00
categories:
  - Java
  - ç¼–ç¨‹
tags:
  - FP
  - Java
  - stream
---


# æµæ˜¯ä»€ä¹ˆ

æµæ˜¯java8 APIçš„æ–°æˆå‘˜ï¼Œå®ƒå…è®¸ä½ ä»¥å£°æ˜æ€§çš„æ–¹å¼å¤„ç†æ•°æ®é›†åˆã€‚

## é›†åˆå¤„ç†æ–¹æ³•æ¯”è¾ƒ

ä½¿ç”¨ä»¥ä¸‹ä»£ç è¿”å›ä½çƒ­é‡èœè‚´çš„åç§°ï¼ŒæŒ‰ç…§å¡è·¯é‡Œæ’åºï¼Œåœ¨ä¸ä½¿ç”¨æµçš„æƒ…å†µä¸‹ï¼Œä¸€èˆ¬æ˜¯ç”¨ä»¥ä¸‹ä»£ç è¿›è¡Œå¤„ç†ã€‚

```java
List<Dish> lowCaloricDishes = new ArrayList<>();
for (Dish d : menu) {
    if (d.getCalories() < 400) {
        lowCaloricDishes.add(d);
    }
}
Collections.sort(lowCaloricDishes, new Comparator<Dish>() {
    public int compare(Dish d1, Dish d2) {
        return Integer.compare(d1.getCalories(), d2.getCalories());
    }
});
List<String> lowCaloricDishesName = new ArrayList<>();
for (Dish d : lowCaloricDishes) {
    lowCaloricDishesName.add(d.getName());
}
```

è¿™æ®µä»£ç ä¸­ä½¿ç”¨äº†ä¸€ä¸ª"åƒåœ¾å˜é‡"lowCaricDishesã€‚å®ƒå”¯ä¸€ä½œç”¨å°±æ˜¯ä½œä¸ºä¸€æ¬¡æ€§çš„ä¸­é—´å®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°é’ˆå¯¹è¿™ä¸ªç®€å•çš„éœ€æ±‚ï¼Œä»£ç å®ç°èµ·æ¥æ¯”è¾ƒå†—ä½™ï¼Œè¿™ä¹Ÿæ˜¯javaä¹‹å‰è¢«é¥±å—è¯Ÿç—…çš„åœ°æ–¹ğŸ˜…ã€‚

è€Œåœ¨java8ä¸­ï¼Œå®ç°çš„ç»†èŠ‚è¢«æ”¾åœ¨å®ƒæœ¬è¯¥å½’å±çš„åº“ä¸­ã€‚

```java
List<String> lowCaloricDishName = 
    menu.stream()
        .filter(d -> d.getCalories() < 400)
        .sorted(Comparator.comparing(Dish::getCalories))
        .map(Dish::getName)
        .collect(Collectors.toList());
```

å¯¹æ¯”ä»¥ä¸Šä»£ç ï¼Œå¯ä»¥çœ‹åˆ°Java8ä½¿ç”¨streamå¯¹é›†åˆè¿›è¡Œå¤„ç†çš„æ–¹æ³•ç®€æ´ã€æ˜äº†ã€‚å¹¶ä¸”è¿˜èƒ½å¤Ÿå……åˆ†åˆ©ç”¨å¤šæ ¸æ¶æ„æå‡æ€§èƒ½â€”â€”åªéœ€è¦å°†stream()æ¢æˆparallelStream()ã€‚

æ€»ç»“ä¸‹ï¼ŒJava8ä¸­çš„Stream APIå¯ä»¥å†™å‡ºå¦‚ä¸‹ä»£ç ï¼š

> å£°æ˜æ€§â€”â€”æ›´ç®€æ´ï¼Œæ›´æ˜“è¯»  
> å¯å¤åˆâ€”â€”æ›´çµæ´»  
> å¯å¹¶è¡Œâ€”â€”æ€§èƒ½æ›´å¥½

# æµç®€ä»‹

> æµç®€çŸ­çš„å®šä¹‰æ˜¯**ä»æ”¯æŒæ•°æ®å¤„ç†çš„æºç”Ÿæˆçš„å…ƒç´ åºåˆ—**  
> **å…ƒç´ åºåˆ—**â€”â€”é›†åˆè®²çš„æ˜¯æ•°æ®ï¼Œæµè®²çš„æ˜¯è®¡ç®—ã€‚  
> **æµæ°´çº¿**â€”â€”å¾ˆå¤šæµæœ¬èº«ä¼šè¿”å›ä¸€ä¸ªæµï¼Œè¿™æ ·æ“ä½œå°±å¯ä»¥è¿æ¥èµ·æ¥ã€‚  
> **å†…éƒ¨è¿­ä»£**â€”â€”ä¸ä½¿ç”¨è¿­ä»£å™¨æ˜¾å¼è¿­ä»£çš„é›†åˆä¸åŒï¼Œæµçš„è¿­ä»£æ“ä½œæ˜¯åœ¨èƒŒåè¿›è¡Œçš„ã€‚

**ä»£ç ç¤ºä¾‹**

```java
package lambdasinaction.chap4;
import java.util.*;

public class Dish {

    private final String name;
    private final boolean vegetarian;
    private final int calories;
    private final Type type;

    public Dish(String name, boolean vegetarian, int calories, Type type) {
        this.name = name;
        this.vegetarian = vegetarian;
        this.calories = calories;
        this.type = type;
    }

    public String getName() {
        return name;
    }

    public boolean isVegetarian() {
        return vegetarian;
    }

    public int getCalories() {
        return calories;
    }

    public Type getType() {
        return type;
    }

    public enum Type { MEAT, FISH, OTHER }

    @Override
    public String toString() {
        return name;
    }

    public static final List<Dish> menu =
        Arrays.asList(
            new Dish("pork", false, 800, Dish.Type.MEAT),
            new Dish("beef", false, 700, Dish.Type.MEAT),
            new Dish("chicken", false, 400, Dish.Type.MEAT),
            new Dish("french fries", true, 530, Dish.Type.OTHER),
            new Dish("rice", true, 350, Dish.Type.OTHER),
            new Dish("season fruit", true, 120, Dish.Type.OTHER),
            new Dish("pizza", true, 550, Dish.Type.OTHER),
            new Dish("prawns", false, 400, Dish.Type.FISH),
            new Dish("salmon", false, 450, Dish.Type.FISH)
        );
}
```

èƒ½å¤Ÿä½“ç°ä¸Šè¿°æ¦‚å¿µçš„ä»£ç ï¼š

```java
List<String> threeHighCaloricDishNames = 
    Dish.menu.stream()
        .filter(d -> d.getCalories() > 300)
        .map(Dish::getName)
        .limit(3)
        .collect(Collectors.toList());
System.out.println(threeHighCaloricDishNames);
```

![æµæ“ä½œç¤ºä¾‹](https://objects.wangaiguo.com/wp-content/uploads/2022/01/image-22.png)

## æµä¸é›†åˆ

ç²—ç•¥çš„è¯´æµä¸é›†åˆçš„å·®å¼‚åœ¨äºä»€ä¹ˆæ—¶å€™è¿›è¡Œè®¡ç®—ï¼Œé›†åˆæ˜¯ä¸€ä¸ªå†…å­˜ä¸­çš„æ•°æ®ç»“æ„ï¼Œå®ƒåŒ…å«æ•°æ®ç»“æ„ä¸­ç›®å‰çš„æ‰€æœ‰å€¼â€”â€”é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ å¿…é¡»å¾—å…ˆè®¡ç®—å‡ºæ¥æ‰èƒ½æ·»åŠ åˆ°é›†åˆä¸­ã€‚æµåˆ™æ˜¯æ¦‚å¿µä¸Šå›ºå®šçš„æ•°æ®ç»“æ„ï¼ˆä½ ä¸èƒ½æ·»åŠ åˆ é™¤å…ƒç´ ï¼‰ï¼Œå…¶å…ƒç´ éƒ½æ˜¯æŒ‰éœ€è®¡ç®—çš„ã€‚

![æµä¸é›†åˆæ¯”è¾ƒ](https://objects.wangaiguo.com/wp-content/uploads/2022/01/image-11.png)

### åªèƒ½éå†ä¸€æ¬¡

å’Œè¿­ä»£å™¨ç±»ä¼¼ï¼Œæµåªèƒ½éå†ä¸€æ¬¡ã€‚éå†å®Œä¹‹åï¼Œæˆ‘ä»¬è¯´è¿™ä¸ªæµå·²ç»è¢«æ¶ˆè´¹ï¼Œä¾‹å¦‚ä»¥ä¸‹ä»£ç ä¼šæŠ¥å¼‚å¸¸ï¼š

```java
List<String> title = Arrays.asList("Java8", "in", "Action");
Stream<String> s = title.stream();
s.forEach(System.out::println);
s.forEach(System.out::println); //è¿™é‡Œæµçš„æ“ä½œå·²ç»è¢«å…³é—­
```

![æµå…³é—­ç¤ºä¾‹](https://objects.wangaiguo.com/wp-content/uploads/2022/01/Image-2-1.png)

é›†åˆä¸æµçš„å¦ä¸€ä¸ªå…³é”®åŒºåˆ«åœ¨äºä»–ä»¬**éå†æ•°æ®çš„æ–¹å¼**ã€‚

### å¤–éƒ¨è¿­ä»£ä¸å†…éƒ¨è¿­ä»£

ä½¿ç”¨Collectionæ¥å£éœ€è¦ç”¨æˆ·å»åšè¿­ä»£ï¼ˆæ¯”å¦‚ä½¿ç”¨for-eachï¼‰ï¼Œè¿™ä¸ªç§°ä¸ºå¤–éƒ¨è¿­ä»£ã€‚ç›¸åStreamåº“ä½¿ç”¨å†…éƒ¨è¿­ä»£â€”â€”å¸®ä½ æŠŠè¿­ä»£åšäº†ã€‚ä½ åªéœ€è¦ç»™å‡ºä¸€ä¸ªå‡½æ•°è¯´å¹²ä»€ä¹ˆã€‚ä¸‹é¢çš„ä»£ç æ˜¾å¼è¿™ç§åŒºåˆ«ï¼š

1. é›†åˆï¼šç”¨for-eachå¾ªç¯å¤–éƒ¨è¿­ä»£

```java
List<String> names = new ArrayList<>();
for (Dish d : menu) {
    names.add(d.getName());
}
```

2. é›†åˆï¼šç”¨èƒŒåçš„è¿­ä»£å™¨åšå¤–éƒ¨è¿­ä»£

```java
List<String> names = new ArrayList<>();
Iterator<Dish> iterator = menu.iterator();
while (iterator.hasNext()) {
    Dish d = iterator.next();
    names.add(d.getName());
}
```

3. æµï¼šå†…éƒ¨è¿­ä»£

```java
List<String> names = menu.stream().map(Dish::getName).collect(Collectors.toList());
```

## æµæ“ä½œ

java.util.stream.Streamä¸­çš„Streamæ¥å£å®šä¹‰äº†è®¸å¤šæ“ä½œã€‚ä»–ä»¬å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ã€‚

```java
List<String> names = menu.stream()
    .filter(d -> d.getCalories() > 300)
    .map(Dish::getName)
    .limit(3)
    .collect(Collectors.toList());
```

ä»ä¸­å¯ä»¥çœ‹åˆ°ä¸¤ç±»æ“ä½œï¼š

- `filter`ã€`map`å’Œ`limit`å¯ä»¥è¿æˆä¸€æ¡æµæ°´çº¿ã€‚
- `collect`è§¦å‘æµæ°´çº¿æ‰§è¡Œå¹¶å…³é—­ã€‚

å¯ä»¥è¿æ¥èµ·æ¥çš„æµæ“ä½œç§°ä¸ºä¸­é—´æ“ä½œï¼Œå…³é—­æµçš„æ“ä½œç§°ä¸ºç»ˆç«¯æ“ä½œã€‚

### ä¸­é—´æ“ä½œ

ä¸­é—´æ“ä½œä¼šè¿”å›å¦ä¸€ä¸ªæµã€‚è¿™è®©å¤šä¸ªæ“ä½œå¯ä»¥è¿æ¥èµ·æ¥å½¢æˆä¸€ä¸ªæŸ¥è¯¢ã€‚é™¤éè§¦å‘ä¸€ä¸ªç»ˆç«¯æ“ä½œï¼Œå¦åˆ™ä¸­é—´æ“ä½œä¸ä¼šæ‰§è¡Œä»»ä½•å¤„ç†ï¼Œè¿™æ˜¯å› ä¸ºä¸­é—´æ“ä½œä¸€èˆ¬éƒ½å¯ä»¥åˆå¹¶èµ·æ¥ï¼Œåœ¨ç»ˆç«¯æ“ä½œæ—¶ä¸€æ¬¡æ€§å…¨éƒ¨å¤„ç†æ‰ã€‚

ä¸ºäº†ææ¸…æ¥šä¸­é—´æ“ä½œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Œéœ€è¦å°†ä»£ç æ”¹ä¸€æ”¹ï¼š

```java
List<String> names = Dish.menu.stream()
    .filter(d -> {    
        System.out.println("filtering " + d.getName());    
        return d.getCalories() > 300;
    })
    .map(d -> {   
        System.out.println("mapping " + d.getName());    
        return d.getName();
    })
    .limit(3)       
    .collect(Collectors.toList());
```

è¿è¡Œç»“æœï¼š

![ä¸­é—´æ“ä½œç¤ºä¾‹](https://objects.wangaiguo.com/wp-content/uploads/2022/01/Image-3-1.png)

æœ‰å¥½å‡ ç§ä¼˜åŒ–åˆ©ç”¨äº†æµçš„å»¶è¿Ÿæ€§è´¨ã€‚åªé€‰å‡ºäº†å‰ä¸‰ä¸ªï¼Œè¿™æ˜¯å› ä¸º`limit`æ“ä½œå’Œä¸€ç§ç§°ä¹‹ä¸ºçŸ­è·¯çš„æŠ€å·§ã€‚å°½ç®¡`filter`å’Œ`map`æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ“ä½œï¼Œä½†æ˜¯å®ƒä»¬åˆå¹¶åˆ°äº†åŒä¸€æ¬¡éå†ä¹‹ä¸­äº†ï¼ˆç§°ä¹‹ä¸ºå¾ªç¯åˆå¹¶ï¼‰ã€‚

### ç»ˆç«¯æ“ä½œ

ç»ˆç«¯æ“ä½œä¼šä»æµçš„æµæ°´çº¿ç”Ÿæˆç»“æœã€‚å…¶ç»“æœæ˜¯ä»»ä½•ä¸æ˜¯æµçš„å€¼ï¼Œæ¯”å¦‚`List`ã€`Integer`ç”šè‡³æ˜¯`void`ï¼Œä¾‹å¦‚ï¼š

```java
menu.stream().forEach(System.out::println);
```

å…¶ä»–çš„ç»ˆç«¯æ“ä½œï¼š

```java
long count = Dish.menu.stream()
    .filter(d -> d.getCalories() > 300)
    .distinct()
    .limit(3)
    .count();
```

# ä½¿ç”¨æµ

æ€»è€Œè¨€ä¹‹ï¼Œæµçš„æ“ä½œä¸€èˆ¬åŒ…æ‹¬ä¸‰ä»¶äº‹ï¼š

1. ä¸€ä¸ªæ•°æ®æºï¼ˆé›†åˆï¼‰æ¥æŒ‡å‘ä¸€ä¸ªæŸ¥è¯¢ã€‚
2. ä¸€ä¸ªä¸­é—´æ“ä½œé“¾ï¼Œå½¢æˆä¸€æ¡æµçš„æµæ°´çº¿ã€‚
3. ä¸€ä¸ªç»ˆç«¯æ“ä½œï¼Œæ‰§è¡Œæµæ°´çº¿ï¼Œå¹¶èƒ½ç”Ÿæˆç»“æœã€‚

ä¸€äº›å¸¸ç”¨çš„æ“ä½œï¼š

### ä¸­é—´æ“ä½œ

| æ“ä½œ     | ç±»å‹   | è¿”å›ç±»å‹   | æ“ä½œå‡½æ•°         | å‡½æ•°æè¿°ç¬¦       |
|----------|--------|------------|------------------|------------------|
| filter   | ä¸­é—´   | Stream<T>  | Predicate<T>     | T -> boolean     |
| map      | ä¸­é—´   | Stream<T>  | Function<T, R>   | T -> R           |
| limit    | ä¸­é—´   | Stream<T>  |                  |                  |
| sorted   | ä¸­é—´   | Stream<T>  | Comparator<T>    | (T, T) -> int    |
| distinct | ä¸­é—´   | Stream<T>  |                  |                  |

### ç»ˆç«¯æ“ä½œ

| æ“ä½œ     | ç±»å‹   | ç›®çš„                                   |
|----------|--------|----------------------------------------|
| foreach  | ç»ˆç«¯   | æ¶ˆè´¹æµä¸­çš„æ¯ä¸ªå…ƒç´ å¹¶å¯¹å…¶åº”ç”¨Lambda     |
| count    | ç»ˆç«¯   | è¿”å›æµä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚è¿™ä¸€æ“ä½œè¿”å›`long` |
| collect  | ç»ˆç«¯   | æŠŠæµå½’çº¦æˆä¸€ä¸ªé›†åˆï¼Œæ¯”å¦‚`List`ã€`Map`ç”šè‡³æ˜¯`Integer` |

## ç­›é€‰å’Œåˆ‡ç‰‡

### ç”¨è°“è¯ç­›é€‰

Streamæ¥å£æ”¯æŒ`filter`æ–¹æ³•ã€‚è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªè°“è¯ï¼ˆä¸€ä¸ªè¿”å›`boolean`çš„å‡½æ•°ï¼‰ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…æ‹¬æ‰€æœ‰ç¬¦åˆè°“è¯çš„å…ƒç´ çš„æµã€‚ä¾‹å¦‚ï¼š

```java
List<Dish> vegetarianMenu = 
    menu.stream().filter(Dish::isVegetarian)
        .collect(Collectors.toList());
```

![ç­›é€‰ç¤ºä¾‹](https://objects.wangaiguo.com/wp-content/uploads/2022/01/image-14.png)

### ç­›é€‰å„å¼‚çš„å…ƒç´ 

æµè¿˜æ”¯æŒä¸€ä¸ªå«åš`distinct`çš„æ–¹æ³•ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªå…ƒç´ å„å¼‚ï¼ˆæ ¹æ®æµæ‰€ç”Ÿæˆå…ƒç´ `hashCode`å’Œ`equals`æ–¹æ³•å®ç°ï¼‰çš„æµã€‚ä¾‹å¦‚ï¼š

```java
List<Integer> numbers = Arrays.asList(1, 2, 1, 3, 3, 2, 4);
numbers.stream()
    .filter(i -> i % 2 == 0)
    .distinct()
    .forEach(System.out::println);
```

![ç­›é€‰å„å¼‚ç¤ºä¾‹](https://objects.wangaiguo.com/wp-content/uploads/2022/01/image-15.png)

### æˆªæ–­æµ

æµæ”¯æŒ`limit(n)`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªä¸è¶…è¿‡ç»™å®šé•¿åº¦çš„æµã€‚

```java
List<Dish> vegetarianMenu = menu.stream()
    .filter(d -> d.getCalories() > 300)
    .limit(3)
    .collect(Collectors.toList());
```

![æˆªæ–­æµç¤ºä¾‹](https://objects.wangaiguo.com/wp-content/uploads/2022/01/image-16.png)

### è·³è¿‡å…ƒç´ 

æµè¿˜æ”¯æŒ`skip(n)`æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªæ‰”æ‰äº†å‰`n`ä¸ªå…ƒç´ çš„æµã€‚å¦‚æœæµä¸­çš„å…ƒç´ ä¸è¶³`n`ä¸ªï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºæµã€‚`limit(n)`å’Œ`skip(n)`æ˜¯äº’è¡¥çš„ã€‚

```java
List<Dish> dishes = menu.stream()
    .filter(d -> d.getCalories() > 300)
    .skip(2)
    .collect(Collectors.toList());
```

![è·³è¿‡å…ƒç´ ç¤ºä¾‹](https://objects.wangaiguo.com/wp-content/uploads/2022/01/image-18.png)

## æ˜ å°„

ä¸€ä¸ªéå¸¸å¸¸è§çš„æ•°æ®å¤„ç†å¥—è·¯å°±æ˜¯ä»å¯¹è±¡ä¸­é€‰æ‹©ä¿¡æ¯ã€‚StreamAPIä¹Ÿé€šè¿‡`map`å’Œ`flatMap`æ–¹æ³•æä¾›äº†ç±»ä¼¼çš„å·¥å…·ã€‚

### å¯¹æµä¸­æ¯ä¸€ä¸ªå…ƒç´ åº”ç”¨å‡½æ•°

ä½¿ç”¨æ˜ å°„ä¸€è¯æ˜¯å®ƒå’Œè½¬æ¢ç±»ä¼¼ï¼Œä½†æ˜¯å·®åˆ«åœ¨äºå®ƒæ˜¯åˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬è€Œä¸æ˜¯å»ä¿®æ”¹ã€‚ä¾‹å¦‚ï¼š

```java
List<String> dishNames = menu.stream()
    .map(Dish::getName)
    .collect(Collectors.toList());
```

æå–èœåé•¿åº¦ï¼š

```java
List<Integer> dishNamesLengths = menu.stream()
    .map(Dish::getName)
    .map(String::length)
    .collect(Collectors.toList());
```

### æµçš„æ‰å¹³åŒ–

å¯¹äºä¸€å¼ å•è¯è¡¨`["hello", "world"]`ï¼Œæƒ³è¦è¿”å›åˆ—è¡¨`["h", "e", "l", "o", "w", "r", "d"]`ã€‚

ç¬¬ä¸€ä¸ªç‰ˆæœ¬å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š

```java
words.stream()
    .map(word -> word.split(""))
    .distinct()
    .collect(Collectors.toList());
```

è¿™ä¸ªæ–¹æ³•çš„é—®é¢˜åœ¨äºï¼Œä¼ é€’ç»™`map`æ–¹æ³•çš„Lambdaä¸ºæ¯ä¸ªå•è¯è¿”å›äº†ä¸€ä¸ª`String[]`ã€‚ç„¶è€ŒçœŸæ­£æƒ³è¦çš„æ˜¯`Stream`æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æµã€‚

#### å°è¯•ä½¿ç”¨`map`å’Œ`Arrays.stream()`

é¦–å…ˆï¼Œéœ€è¦çš„æ˜¯ä¸€ä¸ªå­—ç¬¦æµè€Œä¸æ˜¯æ•°ç»„æµã€‚æœ‰ä¸€ä¸ªå«åš`Arrays.stream()`çš„æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•°ç»„å¹¶äº§ç”Ÿä¸€ä¸ªæµï¼Œä¾‹å¦‚ï¼š

```java
String[] arrayOfWords = {"goodbye", "world"};
Stream<String> streamOfWords = Arrays.stream(arrayOfWords);
```

å°†å®ƒç”¨åœ¨å‰é¢çš„æµæ°´çº¿ä¸­ï¼š

```java
words.stream()
    .map(word -> word.split(""))
    .map(Arrays::stream)
    .distinct()
    .collect(Collectors.toList());
```

å½“å‰çš„æ–¹æ³•ä»ç„¶æä¸å®šï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªæµçš„åˆ—è¡¨ï¼ˆ`Stream`ï¼‰ã€‚

#### ä½¿ç”¨`flatMap`

```java
words.stream()
    .map(word -> word.split(""))
    .flatMap(Arrays::stream)
    .distinct()
    .collect(Collectors.toList());
```

ä½¿ç”¨`flatMap`çš„æ–¹æ³•çš„æ•ˆæœæ˜¯ï¼Œå„ä¸ªæ•°ç»„å¹¶ä¸æ˜¯åˆ†åˆ«æ˜ å°„æˆä¸€ä¸ªæµï¼Œè€Œæ˜¯æ˜ å°„æˆæµçš„å†…å®¹ï¼Œæ‰€ä»¥ä½¿ç”¨`map(Arrays::stream)`æ—¶ç”Ÿæˆçš„å•ä¸ªæµéƒ½è¢«åˆå¹¶èµ·æ¥ï¼Œå³æ‰å¹³åŒ–ä¸ºä¸€ä¸ªæµã€‚

![æ‰å¹³åŒ–ç¤ºä¾‹](https://objects.wangaiguo.com/wp-content/uploads/2022/01/image-20.png)

**æµ‹è¯•**

1. ç»™å®šä¸€ä¸ªæ•°å­—åˆ—è¡¨å¦‚`[1, 2, 3, 4, 5]`ï¼Œè¿”å›`[1, 4, 9, 16, 25]`ã€‚

```java
List<Integer> numbers = Arrays.asList(1, 2, 3, 4, 5);
numbers.stream().map(n -> n * n).collect(Collectors.toList());
```

2. ç»™å®šä¸¤ä¸ªæ•°å­—åˆ—è¡¨è¿”å›æ‰€æœ‰çš„æ•°å¯¹ã€‚

```java
List<Integer> number1 = Arrays.asList(1, 2, 3);
List<Integer> number2 = Arrays.asList(3, 4);
List<int[]> pairs = number1.stream()
    .flatMap(i -> number2.stream()
        .map(j -> new int[]{i, j}))
    .collect(Collectors.toList());
```

æ‰©å±•ï¼Œè¿”å›èƒ½è¢«ä¸‰æ•´é™¤çš„æ•´æ•°å¯¹ï¼š

```java
List<int[]> pairs = number1.stream()
    .flatMap(i -> number2.stream()
        .filter(j -> (i + j) % 3 == 0)
        .map(j -> new int[]{i, j}))
    .collect(Collectors.toList());
```

## æŸ¥æ‰¾å’ŒåŒ¹é…

### æ£€æŸ¥è°“è¯æ˜¯å¦è‡³å°‘åŒ¹é…ä¸€ä¸ªå…ƒç´ 

```java
if (menu.stream().anyMatch(Dish::isVegetarian)) {
    System.out.println("The menu is vegetarian friendly");
}
```

### æ£€æŸ¥è°“è¯æ˜¯å¦åŒ¹é…æ‰€æœ‰å…ƒç´ 

```java
boolean isHealthy = menu.stream().allMatch(d -> d.getCalories() < 1000);
```

**`noneMatch`**

ä¸`allMatch`ç›¸å¯¹çš„æ˜¯`noneMatch`ã€‚

```java
boolean isHealthy = menu.stream().noneMatch(d -> d.getCalories() >= 1000);
```

`anyMatch`ã€`allMatch`å’Œ`noneMatch`è¿™ä¸‰ä¸ªæ“ä½œéƒ½ç”¨åˆ°äº†æ‰€è°“çš„**çŸ­è·¯**ï¼Œç±»ä¼¼Javaä¸­`&&`å’Œ`||`è¿ç®—ç¬¦çŸ­è·¯åœ¨æµä¸­çš„ç‰ˆæœ¬ã€‚å¯¹äºæŸäº›æ“ä½œä¸éœ€è¦å¤„ç†æ•´ä¸ªæµå°±èƒ½å¾—åˆ°ç»“æœã€‚ä¾‹å¦‚ï¼šåªéœ€è¦æ‰¾åˆ°ä¸€ä¸ªå…ƒç´ å°±å¯ä»¥æœ‰ç»“æœã€‚åŒæ ·çš„`limit`ä¹Ÿæ˜¯ä¸€ä¸ªçŸ­è·¯æ“ä½œã€‚

### æŸ¥æ‰¾å…ƒç´ 

`findAny`å°†è¿”å›å½“å‰æµä¸­çš„ä»»æ„å…ƒç´ ã€‚

```java
Optional<Dish> dish = menu.stream().filter(Dish::isVegetarian).findAny();
```

æµæ°´çº¿å°†åœ¨åå°ä¼˜åŒ–ä½¿å…¶åªèµ°ä¸€éï¼Œå¹¶åˆ©ç”¨çŸ­è·¯æ‰¾åˆ°ç»“æœæ—¶ç«‹å³ç»“æŸã€‚

ä¸Šé¢ä¸€æ®µä»£ç ç”¨åˆ°äº†`Optional`ç±»ï¼Œè¯¥ç±»æ˜¯`util`åŒ…ä¸‹çš„ä¸€ä¸ªå®¹å™¨ç±»ï¼Œä»£è¡¨ä¸€ä¸ªå€¼å­˜åœ¨æˆ–ä¸å­˜åœ¨ã€‚è¯¥ç±»æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š

- `isPresent()`ï¼šå°†åœ¨`Optional`åŒ…å«å€¼çš„æ—¶å€™è¿”å›`true`ï¼Œå¦åˆ™è¿”å›`false`ã€‚
- `ifPresent(Consumer<T> block)`ï¼šä¼šåœ¨å€¼å­˜åœ¨çš„æ—¶å€™æ‰§è¡Œç»™å®šçš„ä»£ç å—ã€‚
- `T get()`ï¼šä¼šåœ¨å€¼å­˜åœ¨æ—¶è¿”å›å€¼ï¼Œå¦åˆ™æŠ›å‡ºä¸€ä¸ª`NoSuchElement`å¼‚å¸¸ã€‚
- `T orElse(T other)`ï¼šä¼šåœ¨å€¼å­˜åœ¨æ—¶è¿”å›å€¼ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªé»˜è®¤å€¼ã€‚

ä¾‹å­ï¼š

```java
menu.stream()
    .filter(Dish::isVegetarian)
    .findAny()
    .ifPresent(d -> System.out.println(d.getName()));
```

### æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå…ƒç´ 

æœ‰äº›æµæœ‰ä¸€ä¸ªå‡ºç°é¡ºåºï¼ˆ`encounter order`ï¼‰æ¥æŒ‡å®šæµä¸­é¡¹ç›®å‡ºç°çš„é€»è¾‘é¡ºåºã€‚

```java
List<Integer> someNumbers = Arrays.asList(1, 2, 3, 4, 5);
Optional<Integer> firstSquareDivisibleByThree = someNumbers.stream()
    .map(x -> x * x)
    .filter(x -> x % 3 == 0)
    .findFirst();
```

`findFirst`å’Œ`findAny`éƒ½æ˜¯æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ ï¼ŒåŒºåˆ«åœ¨äºæ‰¾åˆ°ç¬¬ä¸€ä¸ªå…ƒç´ åœ¨å¹¶è¡Œä¸Šé™åˆ¶æ›´å¤šã€‚å¦‚æœä¸å…³å¿ƒè¿”å›çš„å…ƒç´ æ˜¯å“ªä¸ªï¼Œä½¿ç”¨`findAny`ï¼Œå› ä¸ºå®ƒåœ¨ä½¿ç”¨å¹¶è¡Œæµæ—¶é™åˆ¶è¾ƒå°‘ã€‚

## å½’çº³

### å…ƒç´ æ±‚å’Œ

ä½¿ç”¨`for-each`å¾ªç¯å¯¹æ•°å­—åˆ—è¡¨ä¸­çš„å…ƒç´ æ±‚å’Œï¼š

```java
int sum = 0;
for (int x : numbers) {
    sum += x;
}
```

`numbers`ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ç”¨åŠ æ³•è¿ç®—ç¬¦åå¤è¿­ä»£æ¥å¾—åˆ°ç»“æœï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·å¯¹æµä¸­æ‰€æœ‰å…ƒç´ æ±‚å’Œï¼š

```java
int sum = numbers.stream().reduce(0, (a, b) -> a + b);
```

`reduce`æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š

- ä¸€ä¸ªæ˜¯åˆå§‹å€¼ï¼Œè¿™é‡Œæ˜¯`0`ã€‚
- ä¸€ä¸ª`BinaryOperator`æ¥å°†ä¸¤ä¸ªå…ƒç´ ç»“åˆèµ·æ¥äº§ç”Ÿä¸€ä¸ªæ–°å€¼ã€‚

å¯ä»¥ä½¿ç”¨æ–¹æ³•å¼•ç”¨ä½¿è¿™æ®µä»£ç æ›´ç®€æ´ï¼š

```java
int sum = numbers.stream().reduce(0, Integer::sum);
```

**æ— åˆå§‹å€¼**

`reduce`è¿˜æœ‰ä¸€ä¸ªé‡è½½çš„å˜ä½“ï¼Œå®ƒä¸æ¥å—åˆå§‹å€¼ï¼Œä½†æ˜¯ä¼šè¿”å›ä¸€ä¸ª`Optional`å¯¹è±¡ï¼š

```java
Optional<Integer> sum = numbers.stream().reduce((a, b) -> a + b);
```

å› ä¸ºæ²¡æœ‰åˆå§‹å€¼æ‰€ä»¥è¿”å›çš„æ˜¯`Optional`å¯¹è±¡ã€‚

### æœ€å¤§å€¼å’Œæœ€å°å€¼

```java
Optional<Integer> max = numbers.stream().reduce(Integer::max);
Optional<Integer> min = numbers.stream().reduce(Integer::min);
```

![æœ€å¤§å€¼å’Œæœ€å°å€¼ç¤ºä¾‹](https://objects.wangaiguo.com/wp-content/uploads/2022/01/image-22.png)

## æ•°å€¼æµ

åœ¨ä½¿ç”¨`reduce`è®¡ç®—æµä¸­å…ƒç´ çš„ç»¼åˆæ—¶å€™ä¾‹å¦‚ï¼š

```java
int calories = menu.stream().map(Dish::getCalories).reduce(0, Integer::sum);
```

è¿™æ®µä»£ç æœ‰ä¸€ä¸ªéšå«è£…ç®±æˆæœ¬ï¼Œè¿™æ—¶ï¼Œ`Stream`æä¾›äº†åŸå§‹ç±»å‹æµç‰¹åŒ–ï¼Œä¸“é—¨æ”¯æŒå¤„ç†æ•°å€¼æµçš„æ–¹æ³•ã€‚

### åŸå§‹ç±»å‹æµç‰¹åŒ–

Java8 å¼•å…¥äº†ä¸‰ä¸ªåŸå§‹ç±»å‹ç‰¹åŒ–æµæ¥å£æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š`IntStream`ã€`DoubleStream`å’Œ`LongStream`ï¼Œåˆ†åˆ«å°†æµä¸­çš„å…ƒç´ ç‰¹åŒ–ä¸º`int`ã€`long`ã€`double`ã€‚ä»è€Œé¿å…è£…ç®±æˆæœ¬ã€‚

#### æ˜ å°„åˆ°æ•°å€¼æµ

```java
int calories = menu.stream().mapToInt(Dish::getCalories).sum();
```

è¿™é‡Œçš„`mapToInt`ä¼šè¿”å›ä¸€ä¸ª`IntStream`è€Œé`Stream<Integer>`ï¼Œç„¶åå¯ä»¥è°ƒç”¨è¯¥æ¥å£çš„`sum`æ–¹æ³•è¿›è¡Œæ±‚å’Œã€‚å¦‚æœæµæ˜¯ç©ºçš„å°†è¿”å›`0`ã€‚`IntStream`è¿˜æ”¯æŒå…¶ä»–æ–¹æ³•ï¼Œå¦‚`max`ã€`min`ã€`average`ç­‰ã€‚

#### è½¬æ¢å›å¯¹è±¡æµ

```java
IntStream intStream = menu.stream().mapToInt(Dish::getCalories);
Stream<Integer> stream = intStream.boxed();
```

#### é»˜è®¤å€¼`OptionalInt`

å‰é¢æœ‰`Optional`æ¥åŒºåˆ†å€¼å­˜ä¸å­˜åœ¨ã€‚å¯¹äºä¸‰ç§åŸå§‹æµç‰¹åŒ–ï¼Œä¹Ÿåˆ†åˆ«æœ‰ä¸€ä¸ª`Optional`åŸå§‹ç±»å‹ç‰¹åŒ–ç‰ˆæœ¬ï¼š`OptionalInt`ã€`OptionalDouble`ã€`OptionalLong`ã€‚

ä¾‹å¦‚æŸ¥æ‰¾`IntStream`ä¸­æœ€å¤§å…ƒç´ ï¼Œå¯ä»¥è°ƒç”¨`max`æ–¹æ³•ã€‚

```java
OptionalInt maxCalories = menu.stream().mapToInt(Dish::getCalories).max();
```

### æ•°å€¼èŒƒå›´

ç”Ÿæˆæ•°å€¼èŒƒå›´ï¼ŒJava8å¼•å…¥äº†`IntStream`å’Œ`LongStream`çš„é™æ€æ–¹æ³•ï¼Œ`range`å’Œ`rangeClosed`ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯ç¬¬ä¸€ä¸ªæ¥å—å‚æ•°èµ·å§‹å€¼ï¼Œç¬¬äºŒä¸ªæ¥å—ç»“æŸå€¼ã€‚ä½†æ˜¯`range`ä¸åŒ…å«ç»“æŸå€¼ï¼Œ`rangeClosed`åŒ…å«ã€‚

```java
IntStream evenNumbers = IntStream.rangeClosed(1, 100).filter(n -> n % 2 == 0);
```

### æ•°å€¼æµåº”ç”¨

ç”Ÿæˆ100ä»¥å†…çš„å‹¾è‚¡æ•°ï¼š

```java
IntStream.rangeClosed(1, 100).boxed()
    .flatMap(a ->
        IntStream.rangeClosed(a, 100)
            .filter(b -> Math.sqrt(a * a + b * b) % 1 == 0)
            .mapToObj(b -> new int[]{a, b, (int) Math.sqrt(a * a + b * b)}));
```

`IntStream`ä¸­çš„`map`åªèƒ½ä¸ºæµä¸­çš„æ¯ä¸ªå…ƒç´ è¿”å›å¦ä¸€ä¸ª`int`ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨`mapToObj`ã€‚

ä¸Šè¿°æ–¹æ³•éœ€è¦æ±‚ä¸¤æ¬¡å¹³æ–¹æ ¹ï¼Œæ›´å¥½çš„åšæ³•ï¼š

```java
IntStream.rangeClosed(1, 100).boxed()
    .flatMap(a ->
        IntStream.rangeClosed(a, 100)
            .mapToObj(b -> new double[]{a, b, Math.sqrt(a * a + b * b)})
            .filter(t -> t[2] % 1 == 0));
```

## æ„å»ºæµ

### ç”±å€¼åˆ›å»ºæµ

```java
Stream<String> stream = Stream.of("java8", "Lambda", "In", "Action");
```

### ç”±æ•°ç»„åˆ›å»ºæµ

```java
int[] numbers = {1, 2, 3, 4, 5, 67};
int sum = Arrays.stream(numbers).sum(); //è¿”å›çš„æ˜¯IntStream
```

### ç”±æ–‡ä»¶ç”Ÿæˆæµ

æŸ¥çœ‹æ–‡ä»¶ä¸­æœ‰å¤šå°‘å„ä¸ç›¸åŒçš„å•è¯ï¼š

```java
long uniqueWords = 0;
try {
    Stream<String> lines = Files.lines(Paths.get("data.txt"), Charset.defaultCharset());
    uniqueWords = lines.flatMap(line -> Arrays.stream(line.split(" "))).distinct().count();
} catch (IOException e) {
    e.printStackTrace();
}
```

### ç”±å‡½æ•°ç”Ÿæˆæµ

`Stream` API æä¾›äº†ä¸¤ä¸ªé™æ€æ–¹æ³•æ¥ä»å‡½æ•°ç”Ÿæˆæµï¼š`Stream.iterate`å’Œ`Stream.generate`ã€‚è¿™ä¸¤ä¸ªæ“ä½œå¯ä»¥åˆ›å»ºæ‰€è°“çš„æ— é™æµã€‚ä¸€èˆ¬æ¥è¯´åº”è¯¥ä½¿ç”¨`limit(n)`æ¥å¯¹è¿™ç§æµåŠ ä»¥é™åˆ¶ã€‚

#### è¿­ä»£

```java
Stream.iterate(0, n -> n + 2)
    .limit(10)
    .forEach(System.out::println);
```

æ–æ³¢é‚£å¥‘å…ƒç»„åºåˆ—ï¼š

```java
Stream.iterate(new int[]{0, 1}, n -> new int[]{n[1], n[0] + n[1]})
    .limit(20)
    .forEach(t -> System.out.println("(" + t[0] + ", " + t[1] + ")"));
```

#### ç”Ÿæˆ

```java
Stream.generate(Math::random)
    .limit(5)
    .forEach(System.out::println);
```

æˆ‘ä»¬ä½¿ç”¨çš„ä¾›åº”æºæ˜¯æ— çŠ¶æ€çš„ï¼Œå®ƒä¸ä¼šåœ¨ä»»ä½•åœ°æ–¹è®°å½•ä»»ä½•å€¼ã€‚ä½†ä¾›åº”æºä¸ä¸€å®šæ˜¯æ— çŠ¶æ€çš„ï¼Œä½ å¯ä»¥å­˜å‚¨çŠ¶æ€çš„ä¾›åº”æºï¼Œå®ƒå¯ä»¥ä¿®æ”¹çŠ¶æ€ï¼Œå¹¶ä¸ºæµç”Ÿæˆä¸‹ä¸€ä¸ªå€¼çš„æ—¶å€™ä½¿ç”¨ã€‚ä½†æ˜¯åœ¨å¹¶è¡Œåˆ†ä»£ç ä¸­ä½¿ç”¨æœ‰çŠ¶æ€çš„ä¾›åº”æºæ˜¯ä¸å®‰å…¨çš„ã€‚
